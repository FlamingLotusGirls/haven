<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nozzle Layout Visualization</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            margin-bottom: 20px;
        }
        
        #canvas {
            border: 1px solid #444;
            background-color: #2a2a2a;
        }
        
        .info {
            margin-top: 20px;
            text-align: center;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <h1>Nozzle Layout Visualization</h1>
    <canvas id="canvas" width="800" height="800"></canvas>
    
    <div class="info">
        <p>36 nozzles arranged in 6 sections Ã— 3 rings</p>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-circle" style="background-color: #ff6b6b;"></div>
                <span>Ring 0 (3 nozzles per section)</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background-color: #4ecdc4;"></div>
                <span>Ring 1 (2 nozzles per section)</span>
            </div>
            <div class="legend-item">
                <div class="legend-circle" style="background-color: #45b7d1;"></div>
                <span>Ring 2 (1 nozzle per section)</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Canvas center
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        
        // Scale factor to make the visualization fit nicely
        const scale = 80;
        
        // Nozzle configuration (matching the Python code)
        const ringCount = [3, 2, 1];
        const ringRadius = [3.0, 2.0, 1.0];
        const ringBaseAngle = [Math.PI/18.0, Math.PI/12.0, Math.PI/6.0];
        const posAngle = [
            [0, Math.PI/9.0, 2 * Math.PI/9.0],
            [0, Math.PI/6.0],
            [0]
        ];
        
        // Colors for different rings
        const ringColors = ['#ff6b6b', '#4ecdc4', '#45b7d1'];
        
        // Generate nozzle positions
        const nozzles = [];
        let nozzleIdx = 0;
        
        for (let sectionIdx = 0; sectionIdx < 6; sectionIdx++) {
            const baseAngle = sectionIdx * Math.PI / 3.0;
            
            for (let ringIdx = 0; ringIdx < 3; ringIdx++) {
                for (let pos = 0; pos < ringCount[ringIdx]; pos++) {
                    const fullAngle = baseAngle + ringBaseAngle[ringIdx] + posAngle[ringIdx][pos];
                    const radius = ringRadius[ringIdx];
                    
                    const x = Math.sin(fullAngle) * radius;
                    const y = Math.cos(fullAngle) * radius;
                    
                    nozzles.push({
                        idx: nozzleIdx,
                        ringIdx: ringIdx,
                        sectionIdx: sectionIdx,
                        position: pos,
                        x: x,
                        y: y,
                        angle: Math.atan2(x, y),
                        value: 0.0
                    });
                    
                    nozzleIdx++;
                }
            }
        }
        
        // Function to get color based on nozzle value
        function getValueColor(value) {
            // Clamp value to [-1.0, 1.0]
            value = Math.max(-1.0, Math.min(1.0, value));
            
            if (value >= 0.0) {
                // Positive values: red hue (0), full saturation, lightness based on value
                const lightness = value * 50;
                return `hsl(0, 100%, ${lightness}%)`;
            } else {
                // Negative values: blue hue (225), full saturation, lightness based on absolute value
                const lightness = (-value) * 50;
                return `hsl(225, 100%, ${lightness}%)`;
            }
        }
        
        // Function to draw the visualization
        function drawVisualization() {
            // Clear canvas
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw coordinate axes
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            // X axis
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();
            
            // Y axis
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, canvas.height);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Draw center point
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw nozzles with value-based colors
            nozzles.forEach(nozzle => {
                const screenX = centerX + nozzle.x * scale;
                const screenY = centerY - nozzle.y * scale; // Flip Y axis for screen coordinates
                
                // Draw nozzle circle with color based on value
                ctx.fillStyle = getValueColor(nozzle.value);
                ctx.beginPath();
                ctx.arc(screenX, screenY, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw nozzle border
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw nozzle index
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(nozzle.idx.toString(), screenX, screenY);
            });
            
            // Draw section lines
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            
            for (let section = 0; section < 6; section++) {
                const angle = section * Math.PI * 2.0 / 6.0;
                const endX = centerX + Math.sin(angle) * 300;
                const endY = centerY - Math.cos(angle) * 300;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(endX, endY);
                ctx.stroke();
            }
            
            ctx.setLineDash([]);
            
            // Add labels for coordinate system
            ctx.fillStyle = '#aaa';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('(0,0)', centerX + 15, centerY - 10);
            ctx.fillText('+Y', centerX + 15, 30);
            ctx.fillText('-Y', centerX + 15, canvas.height - 20);
            ctx.textAlign = 'left';
            ctx.fillText('+X', canvas.width - 40, centerY - 10);
            ctx.textAlign = 'right';
            ctx.fillText('-X', 40, centerY - 10);
        }
        
        // Function to fetch nozzle data from the REST API
        async function fetchNozzleData() {
            try {
                const response = await fetch('/nozzles');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update nozzle values
                if (Array.isArray(data) && data.length === 36) {
                    for (let i = 0; i < nozzles.length && i < data.length; i++) {
                        nozzles[i].value = data[i];
                    }
                    
                    // Redraw the visualization
                    drawVisualization();
                } else {
                    console.warn('Invalid data format received:', data);
                }
            } catch (error) {
                console.error('Error fetching nozzle data:', error);
                // Continue with previous values on error
            }
        }
        
        // Initial draw
        drawVisualization();
        
        // Start fetching data every 100ms (10 times per second)
        setInterval(fetchNozzleData, 100);
        
        console.log('Generated', nozzles.length, 'nozzles');
        console.log('Live visualization started - fetching data every 100ms');
    </script>
</body>
</html>
